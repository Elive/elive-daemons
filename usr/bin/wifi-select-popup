#!/bin/bash
source /usr/lib/elive-tools/functions

main(){
    # pre {{{

    # }}}

    #if grep -qs "boot=live" /proc/cmdline ; then
        if sudo laptop-detect ; then
            # wait that the system has passed enough time to have been connected
            sleep 30

            if ! el_verify_internet ; then

                # get device name
                wifi_dev="$( LC_ALL=C sudo iwconfig | grep IEEE | awk '{print $1}' | grep "[[:alpha:]]" | head -1 )"

                if [[ -n "$wifi_dev" ]] ; then
                    # activate wifi if was not
                    if sudo iwlist $wifi_dev scan | grep -qs "Nework is down" ; then
                        wifi-activate
                        sleep 10
                    fi

                    # check if we have ESSID's available to connet
                    if ! sudo iwlist $wifi_dev scan | grep -qs "ESSID:" ; then
                        sleep 10
                        if ! sudo iwlist $wifi_dev scan | grep -qs "ESSID:" ; then
                            sleep 10
                        fi
                    fi

                    sleep 2
                    # check if we have ESSID's available to connet
                    if sudo iwlist $wifi_dev scan | grep -qs "ESSID:" ; then

                        # if still not internet, popup it
                        if ! el_verify_internet ; then
                            # appear after a bit of time
                            sleep 30

                            nm-applet --popup &

                            # wait 4 minutes before to close the gadget
                            sleep 240
                            killall nm-applet 1>/dev/null 2>&1
                        fi
                    fi
                fi
            fi
        fi
    #fi

}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :
