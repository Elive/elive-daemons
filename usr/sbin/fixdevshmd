#!/bin/bash
# note: argument -D is ignored, we do the background from another side

main(){
    # pre {{{
    local devshm

    devshm="/dev/shm"

    if [[ -L "${devshm}" ]] ; then
	devshm="$(readlink ${devshm})"
    fi

    # }}}

    # first fix
    chmod 1777 "${devshm}"

    # watch and fix
    while inotifywait -e modify -e attrib "${devshm}"
    do
	# wait a few seconds in order to not overload the system with this daemon, seems like there's something that doesn't finish to change it
	# this pause must be set before to change permissions, in order to directly listed again after that
	sleep 5

	#echo "fixing ${devshm} permissions"
	logger "$(basename $0) - fixing permissions in ${devshm} | auto"
	chmod 1777 "${devshm}"

	#if [[ "$( ls -ld "${devshm}" | awk '{print $1}' )" != *rwxrwxrwt ]] ; then
	    #chmod 1777 "${devshm}"
	    #logger "$(basename $0) - fixing permissions in ${devshm}, needs to be in 1777"
	#fi
    done
}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :

